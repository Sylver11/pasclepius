{% extends 'layout.html' %}

{% block content %}
    <div class="container">
        <h3>Patient Name: {{patient}}</h3>
        <p>Medical Aid: {{medical}}<br>
        Case Number: {{case}}<br>
        PO: {{po}}<br>
        Date of invoice: {{date}}</p>
        <br>
<form id="NewOrderForm" class="form">  
        
        {{ form.hidden_tag() }}

         <table class="table table-striped">
              <thead>
                  <tr>
                      <td><b>Treatment</b></td>
                      <td><b>Date</b></td>        
                  </tr>
              </thead>
              <tbody class="tbodyClone">
                  <tr id="clonedInput0" class="clonedInput">
                      <td>{{  form.treatments(id='treatment-0', class='treatment')  }}</td>
                     
                      <td class="value"></td>
		      <td>
                          <button id="btnAdd_1" name="btnAdd_1" type="button" class="thirty">30%</button>
                          <button id="btnDel_1" name="btnDel_1" type="button" class="fourty">40%</button>
                      </td>

		      <td>{{  form.date(id='date-0')  }}</td>
                      <td>
                          <button id="btnAdd_0" name="btnAdd_0" type="button" class="clone">+</button>
                          <button id="btnDel_0" name="btnDel_0" type="button" class="remove">-</button>
                      </td>
                  </tr>
              </tbody>
          </table>

  <div>{{ form.submit }}</div>
  <span>Result: <span id="result"></span></span>
</form>  


<script>
$(document).ready(function(){

    function addSubmit(ev) {
      ev.preventDefault();  // block the traditional submission of the form.
      $.ajax({
        method: 'POST',
        url: '/generate-invoice',
        data: $('form').serialize(),
      }).done(addShow);
    }

    function addShow(data) {
      $('#result').text(data.result);
    }

    $('#NewOrderForm').on('submit', addSubmit);

    $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
                }
            }
        })

    var regex = /^(.*)(\d)+$/i; 
    var cloneIndex = $(".clonedInput").length; // count how many rows there are
    
    // if there's only one table row, do not show the 'remove' button
    if ($(".clonedInput").length == 1) {
        $('.remove').hide();
    } else {
        $('.remove').show();
    }

    function clone() {
        $(this).parents(".clonedInput").clone() // travels from button to <tr> element
            .appendTo(".tbodyClone") // copied table row is added <tbody>
            .attr("id", "clonedInput" + cloneIndex) // for each table row, id is incremented
            .find("*") // return all descendant elements of selected element.
            .each(function () { // execute function for each matched element
                 var id = this.id || ""; // I'm guessing this makes id a string?
                 var match = id.match(regex) || []; // searches a string against a regular,         
                                                //expression and assigns results to var match as 
                                               //list. Example result 
                                              //["clonedInputNN","clonedInput","NN"]
                 if (match.length == 3) {
                     this.id = match[1] + (cloneIndex);    // match[1] would be the string with the numbers stripped out
                 }
                 var name = this.name || ""; 
                 var match2 = name.match(regex) || []; 
                 if (match2.length == 3) {
                     this.name = match2[1] + (cloneIndex);   
                 }
            }            
            )
            .on('click', 'clone', clone)
            .on('click', 'remove', remove);
        cloneIndex++;
      
        if ($(".clonedInput").length == 1) {
            $('.remove').hide();
        } else {
            $('.remove').show();
        }
    }
    function remove() {        
        $(this).parents(".clonedInput").remove();

        if ($(".clonedInput").length == 1) {
            $('.remove').hide();
        } else {
            $('.remove').show();
        }

    }

    function addPremium(object, id, percent){
        var current_value = parseInt(object.parent().parent().children(".value").text());
	   	let plus_premium = current_value * percent;
	  	object.parent().parent().children(".value").text(plus_premium);
        object.siblings().css('background-color', 'white');
        object.css('background-color', 'green');
        value_edit[id] = {
            id: id,
            value: current_value,
            edit: true,
            last: percent
            };
        console.log(value_edit);
    }

    function subtractPremium(object, id){
        current_value = value_edit[id].value;
        object.parent().parent().children(".value").text(current_value);
		object.css('background-color', 'white');
        object.siblings().css('background-color', 'white');
 	    value_edit[id]={
            id: id,
            value: current_value,
            edit: false,
        }
        console.log(value_edit);
    }

    function replacePremium(object, id, percent){
        original_value = value_edit[id].value;
        let plus_premium = original_value * percent;
	  	object.parent().parent().children(".value").text(plus_premium);
        object.siblings().css('background-color', 'white');
        object.css('background-color', 'green');
        value_edit[id] = {
            id: id,
            value: original_value,
            edit: true,
            last: percent
            };
        console.log(value_edit);
    }


    var value_edit = [];

    $(document).on('click', '.thirty', function(){
        var percent = 1.3;
        var get_id_from_html = $(this).parent().parent().attr('id');
        var id = get_id_from_html.match(regex)[2]
        var object = $(this)
        checkState(object, id, percent)
    })

    function checkState(object, id, percent){    
	    if (typeof value_edit[id] !== 'undefined'){
		    if(value_edit[id].edit == false){
                addPremium(object, id, percent)
		    }
		    else if (value_edit[id].last == percent){
                subtractPremium(object, id)  
		    }
            else{
                replacePremium(object, id, percent)          
            }
		}
	    else{
                addPremium(object, id, percent)
	   }
    }

    $(document).on('click', '.fourty', function(){
        var percent = 1.4;
        var get_id_from_html = $(this).parent().parent().attr('id');
        var id = get_id_from_html.match(regex)[2]
        var object = $(this)
        checkState(object, id, percent)
    })






    $('.thirty').hide()
	$('.fourty').hide()
    var sibling_of_value = null; 
    $(document).on('change', '.treatment',function() {
	  //  console.log($(".clonedInput").length) 
	    	$('.thirty').show()
	    	$('.fourty').show()
		sibling_of_value = $(this);
      		$.getJSON('/get-value', {
        	item: $(this).val()			
      }, function(data) {
        $(sibling_of_value).parent().parent().children(".value").text(data.value);
      });
      return false;
    });


    $(document).on("click", ".clone", clone);
    $(document).on("click", ".remove", remove);
   });

    </script>

 {% endblock %}
