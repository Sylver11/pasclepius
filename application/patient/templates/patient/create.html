{% block content %}
<div class="container"> 
    <br>
    <br>
    <h3>Create new patient</h3> 
    <select class="medical_aid custom-select w-25">
        <option value="0">Select medical aid</option>
        <option value="psemas">PSEMAS</option>
        <option value="mva">MVA</option>
        <option value="other">OTHER</option>
    </select>
    <br>
    <br>
    {% if message %}
        <p>{{ message }}</p>
    {% endif %}
    <form method=post autocomplete="off" id="newInvoice_mva" name="mva" class="mva" style="display:none">  
        {% for field, errors in form_mva.errors.items() %}
        <div class="alert alert-error">
            {{ form_mva[field].label }}: {{ ', '.join(errors) }}
        </div>
        {% endfor %}  
        <div class="form-row">
            {{ form_mva.hidden_tag() }}
            {{ form_mva.medical_aid(value='mva', style='display:none') }}
            <div class="form-group col-md-4">
                {{ form_mva.tariff.label(class="required") }} {{ form_mva.tariff(class_="tariff form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.patient_name.label(class="required",  for="patient_name") }} {{ form_mva.patient_name(class_="form-control") }}
            </div>
        </div>  
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_mva.case_number.label(class="required",  for="case_number") }} {{ form_mva.case_number(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.po_number.label(class="required") }} {{ form_mva.po_number(class_="form-control") }}
            </div>
        </div>
        {% if 4 <= layout_code <= 9 %}
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_mva.hospital_name.label }} {{ form_mva.hospital_name(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.admission_date.label }} {{ form_mva.admission_date(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.discharge_date.label }} {{ form_mva.discharge_date(class_="form-control") }}
            </div>
        </div>
        {% endif %}
        {% if 7 <= layout_code <= 12 %}
        <div class="form-row">
            <div class="form-group col-md-8">
                {{ form_mva.diagnosis.label }} {{ form_mva.diagnosis(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.diagnosis_date.label }} {{ form_mva.diagnosis_date(class_="form-control") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-8">
                {{ form_mva.procedure.label }} {{ form_mva.procedure(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.procedure_date.label }} {{ form_mva.procedure_date(class_="form-control") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_mva.implants.label }} {{ form_mva.implants(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.intra_op.label }} {{ form_mva.intra_op(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_mva.post_op.label }} {{ form_mva.post_op(class_="form-control") }}
            </div>
        </div>
        {% endif %}
        {{ form_mva.date_created.label(class="required") }} {{ form_mva.date_created(id='date_mva', class_="form-control w-25 p-3") }}
        <br>
        {{ form_mva.submit(class_="btn btn-success") }}
    </form>  
    <form  method=post autocomplete="off" id="newInvoice_other" class="other" name="other" style="display:none">  
        {% for field, errors in form_other.errors.items() %}
        <div class="alert alert-error">
            {{ form_other[field].label }}: {{ ', '.join(errors) }}
        </div>
        {% endfor %}
        {{ form_other.hidden_tag() }}
        <div class="form-row">
            <div class="form-group col-md-4">
                {{form_other.medical_aid.label(class="required")}}  {{ form_other.medical_aid(class_="form-control other_medical_aid") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.tariff.label(class="required") }} {{ form_other.tariff(class_="tariff") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_other.patient_name.label(class="required") }} {{ form_other.patient_name(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.main_member.label(class="required") }} {{ form_other.main_member(class_="form-control") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_other.patient_birth_date.label(class="required") }} {{ form_other.patient_birth_date(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.medical_number.label(class="required") }} {{ form_other.medical_number(class_="form-control") }}
            </div>
        </div>
        {% if 4 <= layout_code <= 9 %}
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_other.hospital_name.label }} {{ form_mva.hospital_name(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.admission_date.label }} {{ form_mva.admission_date(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.discharge_date.label }} {{ form_mva.discharge_date(class_="form-control") }}
            </div>
        </div>
        {% endif %}
        {% if 7 <= layout_code <= 12 %}
        <div class="form-row">
            <div class="form-group col-md-8">
                {{ form_other.diagnosis.label }} {{ form_mva.diagnosis(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.diagnosis_date.label }} {{ form_mva.diagnosis_date(class_="form-control") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-8">
                {{ form_other.procedure.label }} {{ form_mva.procedure(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.procedure_date.label }} {{ form_mva.procedure_date(class_="form-control") }}
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                {{ form_other.implants.label }} {{ form_mva.implants(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.intra_op.label }} {{ form_mva.intra_op(class_="form-control") }}
            </div>
            <div class="form-group col-md-4">
                {{ form_other.post_op.label }} {{ form_mva.post_op(class_="form-control") }}
            </div>
        </div>
        {% endif %}
        {{ form_other.date_created.label(class="required")  }} {{ form_other.date_created(id='date_other', class_="form-control w-25 p-3") }}
        <br>
        {{ form_other.submit(class_="btn btn-success") }}
    </form>  
</div>
<script>

    $(document).ready(function() {

        function dynamic(load_content){
            $( "#invoice-tab" ).load( load_content, function(){
                var invoice_container = document.getElementById("container_id");
                document.getElementById("container_id").classList.add('invoice_draft_class');
                localStorage.setItem("invoice_draft", invoice_container.outerHTML); 
                // keepState();
                // setTimeout(keepState,1000);
        
                var lower_navbar = document.getElementById("myTab")
                var tab = document.createElement("BUTTON");  
                tab.setAttribute("id", "tab-draft");
                tab.textContent = "Draft";
                tab.addEventListener("click", function(e){ 
                    e.preventDefault();
                    document.getElementById("invoice-tab").innerHTML = localStorage.getItem("invoice_draft");
                    // $('#invoice-tab').html(localStorage.getItem("invoice_draft"));
                    // console.log(document.getElementById("container_id"))
                    // setInterval(keepState,1000);
                    // var invoice_container = document.getElementById("container_id");
                    // localStorage.setItem("invoice_draft", invoice_container.innerHTML);
                    }, false);
                lower_navbar.appendChild(tab);

        })
        }

    //     function getLocalStorage(){
    //     dynamic(localStorage.getItem('invoice_draft'))
    // }

        function isValidDate(dateString){
            if(!/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(dateString))
                return false;

            var parts = dateString.split(".");
            var day = parseInt(parts[0], 10);
            var month = parseInt(parts[1], 10);
            var year = parseInt(parts[2], 10);

            if(year < 1000 || year > 3000 || month == 0 || month > 12)
                return false;

            var monthLength = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 ];

            if(year % 400 == 0 || (year % 100 != 0 && year % 4 == 0))
                monthLength[1] = 29;

            return day > 0 && day <= monthLength[month - 1];
        };


        $('.other').children('#date_other').datepicker({dateFormat: 'dd.mm.yy'})
        $('.mva').children('#date_mva').datepicker({dateFormat: 'dd.mm.yy'})
        $('.psemas').children('#date_psemas').datepicker({dateFormat: 'dd.mm.yy'})
        $('#procedure_date').datepicker({dateFormat: 'dd.mm.yy'})
        $('#diagnosis_date').datepicker({dateFormat: 'dd.mm.yy'})
        $('#admission_date').datepicker({dateFormat: 'dd.mm.yy'})
        $('#discharge_date').datepicker({dateFormat: 'dd.mm.yy'})
        $(document).on('change', '.medical_aid',function() {
            var selection = $(this).val()
            if(selection == 'mva'){
                $('.other').css("display","none")
                $('.mva').css("display","block")

            }
            else if(selection == "other"){
                $('.other_medical_aid').val('')
                $('.mva').css("display","none")
                $('.other').css("display","block")
            }
            else{
                console.log(selection);
                $('.other_medical_aid').val(selection)
                $('.mva').css("display","none")
                $('.other').css("display","block")
            }
        })

        $('.mva').submit(function (e) {
            var x = document.forms["mva"]["tariff"].value; 
            if (x == "") {
                e.preventDefault();
                alert("Tariff must be chosen.");
            }else{
                var url = "{{ url_for('patient_bp.createPatient') }}";
                $.ajax({
                type: "POST",
                url: url,
                data: $('.mva').serialize(),
                success: function (returnData) {
                    const obj = JSON.parse(returnData)
                    // console.log(obj)
                    if(obj == "mva"){
                        let criteria = ["/patient/invoice/new"];
                        dynamic.apply(this, criteria);  
                    }
                }
            });
            e.preventDefault();
            } 

        });

        $('.other').submit(function (e) {
            var x = document.forms["other"]["tariff"].value;
            var y = document.forms["other"]["patient_birth_date"].value;
            if (x == "") {
                e.preventDefault();
                alert("Tariff must be chosen.");
            }else if(isValidDate(y)){
                var url = "{{ url_for('patient_bp.createPatient') }}";
                $.ajax({
                type: "POST",
                url: url,
                data: $('.other').serialize() ,
                success: function (returnData) {
                    const obj = JSON.parse(returnData)
                    // console.log(obj)
                    if(obj == "other"){
                        let criteria = ["/patient/invoice/new"];
                        dynamic.apply(this, criteria);  
                    }
                }
            });
            e.preventDefault();
            } 
            else{
                e.preventDefault();
                alert("Patient birth date has an incorrect format. Please use the following format: dd.mm.yyyy");
            } 

        });

        var other_medical_aid_field = document.querySelector('.other_medical_aid');
        other_medical_aid_field.addEventListener('keypress', function ( e ) {  
            var key = e.keyCode;
            if (key === 32) {
                e.preventDefault();
                alert("No whitespace please :)");
            }
        });
        
        

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ form_mva.csrf_token._value() }}")
                }
            }
        })


        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ form_other.csrf_token._value() }}")
                }
            }
        })
    });

</script>
 {% endblock %}