{% extends 'patient/layout.html' %}
{% block content %}
<nav class="navbar navbar-expand-sm navbar-dark" style="background-color:#017B25;">
    <ul class="navbar-nav" id="myTab">
        <a class="new-patient nav-link nav-item" href="/patient/">New patient</a>
        <a class="continue nav-link nav-item" href="/patient/">Continue</a>
    </ul>
</nav>
<div class="jumbotron jumbotron-fluid" style="height:88%; margin:0">
    <div class="container">
        <div id="invoice-tab" class="d-flex flex-column"></div>
    </div>
</div>

<script>   

$(document).ready(function(){

    function dynamic(load_content){
        $( "#invoice-tab" ).load( load_content, function(){
        });
    }


    $.ajax({
        type: "GET",
        url: '/patient/last-five', 
        data: {work_type: "invoice_draft"},
        success: function (patient) {
            if(patient.length > 2){
                var lower_navbar = document.getElementById("myTab")
                var draft_button = document.createElement("BUTTON");  
                draft_button.setAttribute("id", "tab-draft");
                draft_button.className += " btn";
                draft_button.className += " btn-secondary "
                draft_button.className += " btn-sm "
                draft_button.style.marginLeft = "2em";
                draft_button.textContent = "Draft";
                draft_button.addEventListener("click", function(e){ 
                    e.preventDefault();
                    var tabs = lower_navbar.getElementsByTagName('BUTTON');
                    for (var i = 0; i < tabs.length; i++) {
                        tabs[i].classList.remove("active");
                    }
                    $('.continue').removeClass('active');
                    $('.new-patient').removeClass('active'); 
                    $(this).addClass('active'); 

                    $.ajax({
                        type: "GET",
                        url: '/patient/last-five', 
                        data: {work_type: "invoice_draft"},
                        success: function (patient) {
                            patient = JSON.parse(patient);
                            patient = JSON.parse(patient[0]["work_quality"].replace(/\\"/g, '"'));
                            $.get( "/patient/invoice/new", {"tariff": patient["tariff"], "status": "continue_draft"}, function( data ) {
                                    $( "#invoice-tab" ).html( data );
                                });
                        }
                    })
                }, false);

                var favi = document.createElement("I");
                favi.setAttribute("class" , "fa fa-remove")
                favi.setAttribute("id" , "draft_delete_favi")
                favi.style.paddingLeft ="5px";
                favi.addEventListener("click", function(e){
                    e.preventDefault();
                    $.ajax({
                        type: "GET",
                        url: '/remove-job', 
                        data: {work_type: "invoice_draft", work_quality: "any"},
                        success: function (status) {
                            favi_to_be_removed = document.getElementById("draft_delete_favi");
                            favi_to_be_removed.remove();
                            tab_to_be_removed = document.getElementById("tab-draft");
                            tab_to_be_removed.remove();
                        }
                    }) 
                });

                if(document.getElementById("tab-draft")){
                    lower_navbar.replaceChild(draft_button, document.getElementById("tab-draft"));
                }
                else{
                    var referenceNode = document.getElementById("tab-0")
                    lower_navbar.insertBefore(draft_button, referenceNode)
                    lower_navbar.insertBefore(favi, referenceNode)
 
                }
          }
        }
      })


    $.ajax({
        type: "GET",
        url: '/patient/last-five', 
        data: {work_type: "invoice_tab"},
        success: function (returnData) {
          const obj = JSON.parse(returnData)
          var lower_navbar = document.getElementById("myTab")

          for (let i = 0; i < obj.length; i++) {
            const element = obj[i];
            var tab = document.createElement("BUTTON");
            tab.setAttribute("id", "tab-" + i);
            tab.setAttribute("type", "button"); 
            tab.className += " btn";
            tab.className += " btn-sm "
            tab.className += " btn-secondary "
            
            tab.className += element["work_quality"];
            tab.className += " tab";
            tab.style.marginLeft = "1em";
            tab.textContent = element["work_quality"]

            lower_navbar.appendChild(tab);

            var favi = document.createElement("I");
            favi.setAttribute("id" , "favi-" + i)
            favi.setAttribute("class" , "fa fa-remove favi")
            favi.style.paddingLeft ="5px";
            favi.addEventListener("click", function(e){
                e.preventDefault();
                $.ajax({
                    type: "GET",
                    url: '/remove-job', 
                    data: {work_type: "invoice_tab", work_quality: element["work_quality"]},
                    success: function (status) {
                        tab_to_be_removed = document.getElementById("tab-" + i)
                        tab_to_be_removed.remove();
                        favi_to_be_removed = document.getElementById("favi-" + i)
                        favi_to_be_removed.remove();
                    }
                }) 
            });
            lower_navbar.appendChild(favi);
          }
        }
      })


    $(document).on("click", ".new-patient", function (e) {
        e.preventDefault();
        criteria[0] = "/patient/invoice/create";
        dynamic.apply(this, criteria); 
        var lower_navbar = document.getElementById("myTab");
        var tabs = lower_navbar.getElementsByTagName('BUTTON');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }
        $('.continue').removeClass('active');
        $('.new-patient').addClass('active');         
    })


    $(document).on("click", ".continue", function (e) {
        e.preventDefault();
        criteria[0] = "/patient/invoice/continue";
        dynamic.apply(this, criteria); 
        var lower_navbar = document.getElementById("myTab");
        var tabs = lower_navbar.getElementsByTagName('BUTTON');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }
        $('.new-patient').removeClass('active');  
        $('.continue').addClass('active');     
    })

    
    $(document).on("click", ".tab", function (e) {  
        e.preventDefault();   
        var invoice_id = $(this).text();
        criteria[0] = "/patient/invoice/" + invoice_id;
        dynamic.apply(this, criteria); 
        var lower_navbar = document.getElementById("myTab");
        var tabs = lower_navbar.getElementsByTagName('BUTTON');
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }
        $('.new-patient').removeClass('active'); 
        $('.continue').removeClass('active');
        $(this).addClass('active');  
    })


    let criteria = ["/patient/invoice/create"];
    $('.new-patient').addClass('active');
    dynamic.apply(this, criteria);

})

</script>
{% endblock %}
