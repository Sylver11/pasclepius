<div id='invoice_list'></div>

<script>

function dynamic(load_content){
        $( "#invoice-tab" ).load( load_content, function(){
        });
    }

function closeDropDown(){
    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
        var openDropdown = dropdowns[i];
        if (openDropdown.classList.contains('show')) {
                openDropdown.classList.remove('show');
        }
    }
}

    var invoices = '{{ invoices_json }}';
    invoices = JSON.parse(invoices.replace(/&#34;/g,'"'));
    var invoice_list = document.getElementById("invoice_list");
    invoice_list.style.display = "flex";
    invoice_list.style.flexDirection = "column";

for (let i = 0; i < invoices.length; i++) {
        const element = invoices[i];


        var invoice_wrapper = document.createElement("DIV");
        invoice_wrapper.style.display = "flex";
        invoice_wrapper.style.flexDirection = "row";
        invoice_wrapper.style.justifyContent = "space-between";
        if(element['status'] == 'not-submitted'){
            invoice_wrapper.style.backgroundColor = "rgba(0, 0, 255, 0.3)";
        }
        else if(element['status'] == 'due'){
            invoice_wrapper.style.backgroundColor = "rgb(255, 255, 0, 0.3)";
        }
        else if(element['status'] == 'overdue'){
            invoice_wrapper.style.backgroundColor = "rgba(255, 0, 0, 0.3)";
        }
        else if(element['status'] == 'settled'){
            invoice_wrapper.style.backgroundColor = "rgba(0, 255, 0, 0.3)";
        } 
        invoice_list.appendChild(invoice_wrapper);
        


        var left_wrapper = document.createElement("DIV");
        left_wrapper.style.width = "30%";
        invoice_wrapper.appendChild(left_wrapper);

        var info_wrapper = document.createElement("DIV");
        left_wrapper.appendChild(info_wrapper);

        var statement_wrapper = document.createElement("DIV");
        left_wrapper.appendChild(statement_wrapper);



        var right_wrapper = document.createElement("DIV");
        right_wrapper.style.width = "20%";
        invoice_wrapper.appendChild(right_wrapper);

        var action_wrapper = document.createElement("DIV");
        right_wrapper.appendChild(action_wrapper);

        var status_wrapper = document.createElement("DIV");
        right_wrapper.appendChild(status_wrapper);



        var id = document.createElement("DIV");

        var invoice_id = document.createElement("DIV");
        invoice_id.textContent = element['invoice_id'];
        id.appendChild(invoice_id);

        var patient_name = document.createElement("DIV");
        patient_name.textContent = element['patient_name'];
        id.appendChild(patient_name);
                        
        info_wrapper.appendChild(id);


        var current_status = document.createElement("DIV");


        if(element['submitted_on']){
            var submitted_on = document.createElement("DIV");
            submitted_on.textContent = "Submitted on: " + element['submitted_on'];
            current_status.appendChild(submitted_on);
        }
        
        var invoice_created = document.createElement("DIV");
        invoice_created.textContent = "Created on: " + element['date_created'];
        current_status.appendChild(invoice_created);
                        
        var invoice_date = document.createElement("DIV");
        invoice_date.textContent = "Invoice date: " + element['date_invoice'];
        current_status.appendChild(invoice_date);

        status_wrapper.appendChild(current_status);

        var continue_button = document.createElement("BUTTON");
        continue_button.addEventListener("click", function(){
            let criteria = ["/patient/invoice/" + element['invoice_id']]; 
            $('.new-patient').removeClass('active'); 
            $('.continue').removeClass('active');

            var lower_navbar = document.getElementById("myTab")
            var tabs = lower_navbar.getElementsByTagName('BUTTON');

            var tab_does_not_exists = true;
            for (var i = 0; i < tabs.length; i++) {
                if(tabs[i].textContent.match(element['invoice_id'])){
                    tabs[i].className += " active";
                    tabs[i].disabled = false;
                    tab_does_not_exists = false;
                }
            } 
      
            if(tab_does_not_exists){
   
                var tab = document.createElement("BUTTON");
                tab.setAttribute("id", "tab-" + i);
                tab.className += " btn";
                tab.className += " btn-secondary "
                tab.className += " btn-sm "
                tab.className += element['invoice_id'];
                tab.className += " tab";
                tab.style.marginLeft = "2em";
                tab.textContent =element['invoice_id'];

                var favi = document.createElement("I");
                favi.setAttribute("id" , "favi-" + i)
                favi.setAttribute("class" , "fa fa-remove favi")
                favi.style.paddingLeft ="5px";
                favi.addEventListener("click", function(e){
                    e.preventDefault();
                    $.ajax({
                            type: "GET",
                            url: '/remove-job', 
                            data: {work_type: "invoice_tab", work_quality: element['invoice_id']},
                            success: function (status) {
                                favi_to_be_removed = document.getElementById("favi-" + i)
                                favi_to_be_removed.remove();
                                tab_to_be_removed = document.getElementById("tab-" + i)
                                tab_to_be_removed.remove();
                            }
                        }) 
                });

                var  number_of_already_existing_tabs= document.getElementsByClassName("tab");
                var  number_of_already_existing_favis= document.getElementsByClassName("favi");
                if(number_of_already_existing_tabs.length > 4){
                    number_of_already_existing_tabs[4].remove();
                    number_of_already_existing_favis[4].remove();
                    lower_navbar.insertBefore(favi, number_of_already_existing_tabs[0])
                    lower_navbar.insertBefore(tab, favi)
                }
                else{
                    lower_navbar.insertBefore(favi, number_of_already_existing_tabs[0])
                    lower_navbar.insertBefore(tab, favi)    
                }
            }
            dynamic.apply(this, criteria);  
            });
        continue_button.textContent = "Continue";
        action_wrapper.appendChild(continue_button);
    }

</script>
